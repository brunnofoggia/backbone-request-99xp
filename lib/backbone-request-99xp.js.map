{"version":3,"file":"backbone-request-99xp.js","sources":["../src/backbone-request-99xp.js"],"sourcesContent":["// [backbone-request-99xp](https://github.com/brunnofoggia/backbone-request-99xp) is an integration that makes possible to use\n// [backbone](https://backbonejs.org) with promises in nodejs. That's done by integrating it with [axios](https://github.com/axios/axios).\n\n\n// Examples\n// --------------\n\n// Considere this Model as base for the examples\n//\n//     var Model = bbr.Model.extend({\n//         urlRoot: 'https://tapi.99xp.org/crud/test'\n//     }),\n\n// * getting row \n//   1. with listener\n//\n//          model = new Model({id: 35});\n//          model.once('sync', ()=>{\n//              console.log(model.attributes);\n//          });\n//          model.fetch({headers: {...}});\n//   2. with promise\n//\n//          model = new Model({id: 35});\n//          return model.fetchp((m, o, resolve, reject) => {\n//              console.log(m.attributes);\n//              resolve();\n//          }, {headers: {...}});\n// * inserting row \n//   1. with listener\n//\n//          model = new Model({name: 'new person', age: 10});\n//          model.once('sync', ()=>{\n//              console.log(model.attributes);\n//          });\n//          model.save();\n//   2. with promise\n//\n//          model = new Model({name: 'new person', age: 10});\n//          return model.savep((m, o, resolve, reject) => {\n//              console.log(m.attributes);\n//              resolve();\n//          });\n\n// CODE DOCUMENTED BELOW\n// --------------\n\n// --------------\n\n// Baseline setup\n// --------------\nimport Backbone from 'backbone';\nimport _ from 'underscore-99xp';\nimport axios from 'axios';\n\n/* templater settings */\n_.templateSettings = {\n    interpolate: /\\{\\{(.+?)\\}\\}/g,\n    evaluate: /\\{\\%(.+?)\\%\\}/g,\n    escape: /\\{-([\\s\\S]+?)-\\}/g\n};\n\nvar BackboneRequest = _.clone(Backbone);\n\nBackboneRequest.VERSION = '0.1.0';\n\n// Turn on `emulateHTTP` to support legacy HTTP servers. Setting this option\n// will fake `\"PATCH\"`, `\"PUT\"` and `\"DELETE\"` requests via the `_method` parameter and\n// set a `X-Http-Method-Override` header.\nBackboneRequest.emulateHTTP = false;\n\n// Turn on `emulateJSON` to support legacy servers that can't deal with direct\n// `application/json` requests ... this will encode the body as\n// `application/x-www-form-urlencoded` instead and will send the model in a\n// form param named `model`.\nBackboneRequest.emulateJSON = false;\n\n// Sync engine modeled over default backbone.js ajax syncing engine\n// It will make model rest methods to work for both, node and browser\nBackboneRequest.sync = function(method, model, options) {\n    var type = methodMap[method];\n\n    // Default options, unless specified.\n    _.defaults(options || (options = {}), {\n        emulateHTTP: BackboneRequest.emulateHTTP,\n        emulateJSON: BackboneRequest.emulateJSON,\n        headers: {}\n    });\n\n    // Default JSON-request options.\n    var params = _.extend({}, options, {\n        type: type,\n        dataType: 'json'\n    });\n\n    // Ensure that we have a URL.\n    if (!options.url) {\n        params.url = _.result(model, 'url') || BackboneRequest.urlError();\n    }\n\n    // Ensure that we have the appropriate request data.\n    if (options.data == null && model && (method === 'create' || method === 'update' || method === 'patch')) {\n        params.contentType = 'application/json';\n        params.data = JSON.stringify(options.attrs || model.toJSON(options));\n    }\n\n    // For older servers, emulate JSON by encoding the request into an HTML-form.\n    if (options.emulateJSON) {\n        params.contentType = 'application/x-www-form-urlencoded';\n        params.data = params.data ? {\n            model: params.data\n        } : {};\n    }\n\n    // For older servers, emulate HTTP by mimicking the HTTP method with `_method`\n    // And an `X-HTTP-Method-Override` header.\n    if (options.emulateHTTP && (type === 'PUT' || type === 'DELETE' || type === 'PATCH')) {\n        params.type = 'POST';\n        if (options.emulateJSON) {\n            params.data._method = type;\n        }\n        params.headers['X-HTTP-Method-Override'] = type;\n    }\n\n    // Don't process data on a non-GET request.\n    if (params.type !== 'GET' && !options.emulateJSON) {\n        params.processData = false;\n    }\n\n    // Request & Parse engine\n    var reqOpts = _.extend({\n        url: params.url,\n        method: params.type,\n        headers: params.headers\n    }, _.pick(params, 'data'), _.omit(options, 'type', 'dataType', 'emulateHTTP', 'emulateJSON'));\n\n    reqOpts.headers['content-type'] = params.contentType || 'application/json';\n\n    // Promise calls\n    reqOpts.then = _.partial((m, o, response) => {\n        typeof o.success === 'function' && o.success(response.data);\n    }, this, options);\n    reqOpts.catch = _.bind(_.partial((m, o, err) => {\n        this._reqErr = err;\n        typeof o.error === 'function' && o.error(err);\n    }, this, options), this);\n\n\n    return BackboneRequest.exec(reqOpts);\n};\n\n// Format data for request\nBackboneRequest.exec = function(options, req = null, res = null) {\n    if (typeof options.url !== 'string' ||\n        // Accept to execute http requests without receiving res object if callbacks are present in options\n        (!res && _.size(_.pick(options, 'then', 'catch')) < 2)) {\n        return false;\n    }\n\n    var reqOpts = _.defaults(_.pick(options, 'url', 'method', 'headers', 'data'), {\n        method: 'GET',\n        headers: {}\n    });\n\n    // default promise calls\n    (typeof options.then !== 'function') && (options.then = (response, _req, _res) => {\n        _res.status(response.status).send(response.data);\n    });\n    (typeof options.finally !== 'function') && (options.finally = () => {});\n    (typeof options.catch !== 'function') && (options.catch = (error, _req, _res) => {\n        try {\n            var data = error.response.data;\n            if (typeof data !== 'object') {\n                try {\n                    data = JSON.parse(data);\n                } catch (e) {\n                    data = {\n                        message: data\n                    };\n                }\n            }\n\n            _res.status(error.response.status).send(JSON.stringify(data));\n        } catch (e) {\n            _res.status(500).send(JSON.stringify({\n                message: 'Internal Failure'\n            }));\n        }\n    });\n\n    // Axios call\n    return axios(reqOpts)\n        .then(_.partial((_req, _res, o, r) => options.then(r, _req, _res), req, res, options))\n        .catch(_.partial((_req, _res, o, err) => options.catch(err, _req, _res), req, res, options))\n        .finally(_.partial((_req, _res, o) => options.finally(_req, _res), req, res, options));\n}\n\n// Map from CRUD to HTTP for our default `Backbone.sync` implementation.\nvar methodMap = {\n    'create': 'POST',\n    'update': 'PUT',\n    'patch': 'PATCH',\n    'delete': 'DELETE',\n    'read': 'GET'\n};\n\n// Throw an error when a URL is needed, and none is supplied.\nBackboneRequest.urlError = function() {\n    throw new Error('A \"url\" property or function must be specified');\n};\n\n_.map(['Events'], (x) => BackboneRequest[x] = _.clone(Backbone[x]));\n_.map(['Model', 'Collection'], (x) => BackboneRequest[x] = Backbone[x].extend({\n    // constructor\n    initialize(data = {}, options = {}) {\n        this.setRouterParameters(options.req, options.res);\n    },\n    // easier way to have express variables inside the object to use them in callbacks\n    setRouterParameters(req = null, res = null) {\n        this._req = req;\n        this._res = res;\n    },\n    // Replacing prototype of sync to call custom sync method\n    sync() {\n        return BackboneRequest.sync.apply(this, arguments);\n    },\n    // Shortcuts for clearer promise use\n    fetchp(fn, o = {}) {\n        o.success = fn;\n        return this.fetch(o);\n    },\n    savep(fn, o = {}) {\n        o.success = fn;\n        return this.save(null, o);\n    },\n    destroyp(fn, o = {}) {\n        o.success = fn;\n        return this.destroy(o);\n    },\n}));\n\n\nexport default BackboneRequest;\n"],"names":["_","templateSettings","interpolate","evaluate","escape","BackboneRequest","clone","Backbone","VERSION","emulateHTTP","emulateJSON","sync","method","model","options","type","methodMap","defaults","headers","params","extend","dataType","url","result","urlError","data","contentType","JSON","stringify","attrs","toJSON","_method","processData","reqOpts","pick","omit","then","partial","m","o","response","success","catch","bind","err","_reqErr","error","exec","req","res","size","_req","_res","status","send","finally","parse","e","message","axios","r","Error","map","x","initialize","setRouterParameters","apply","arguments","fetchp","fn","fetch","savep","save","destroyp","destroy"],"mappings":"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"}