{"version":3,"file":"backbone-request-99xp.js","sources":["../src/http.js","../src/backbone-request-99xp.js"],"sourcesContent":["// current version commented\n\nimport _ from 'underscore-99xp';\nimport https from 'https';\nimport http from 'http';\nimport ExceptionResponse from 'app-exception/src/Response';\n\nvar exec = async function (options, req = null, res = null) {\n    if (typeof options.url !== 'string' ||\n            // Accept to execute http requests without receiving res object if callbacks are present in options\n                    (!res && _.size(_.pick(options, 'then', 'catch')) < 2)) {\n        return false;\n    }\n\n    var defaults = _.defaults({\n        method: 'GET',\n        rejectUnauthorized: false,\n        headers: {\n            'content-type': 'application/json'\n        },\n        timeout: 18000000\n    }, !options.url ? {} : _.parseUrl(options.url));\n\n    // default promise calls\n    (typeof options.then !== 'function') && (options.then = async (response, data, _req, _res) => {\n        if(_res) {\n            return !_res._headerSent && _res.status(response.statusCode || 200).send(data);\n        }\n        throw new ExceptionResponse(JSON.stringify(data), 0, response.statusCode || 200);\n    });\n    (typeof options.finally !== 'function') && (options.finally = async () => {\n    });\n    (typeof options.catch !== 'function') && (options.catch = async (response, data, _req, _res) => {\n        try {\n            if (typeof data !== 'object') {\n                try {\n                    data = _.isString(data) ? JSON.parse(data) : data;\n                } catch (e) {\n                    data = {\n                        message: data\n                    };\n                }\n            }\n\n            var status = _.isObject(response) ? response.statusCode || 500 : 500;\n            if(_res) {\n                return !_res._headerSent && _res.status(status).send(data);\n            }\n            throw new ExceptionResponse(JSON.stringify(data), 0, status);\n        } catch (e) {\n            if(_res) {\n                return !_res._headerSent && _res.status(_.isObject(e) ? e.statusCode || 500 : 500).send(e);\n            }\n            throw new ExceptionResponse(e, 0, _.isObject(e) ? e.statusCode || 500 : 500);\n        }\n    });\n\n    var reqOpts = _.defaults2(_.pick(options,\n        'url', 'method', 'headers', 'data', 'timeout', 'secureProtocol', 'minVersion', 'maxVersion', 'then', 'catch'),\n    defaults);\n\n    if (!reqOpts.rejectUnauthorized) {\n        process.env.NODE_TLS_REJECT_UNAUTHORIZED = 0;\n    }\n\n    if (reqOpts.method !== 'GET' && reqOpts.data) {\n        if (_.isJSON(reqOpts.data)) {\n            reqOpts.data = JSON.stringify(reqOpts.data);\n        }\n        reqOpts.headers['Content-Length'] = Buffer.byteLength(reqOpts.data);\n    }\n\n    return new Promise(_.partial(async (_o, resolve, reject) => {\n        const httprequest = defineLib(_o);\n\n        const r = httprequest.request(_.omit(_o, 'data'), async (resp) => {\n            let chunks = [];\n            resp.setEncoding('utf8');\n            resp.on('data', chunk => { chunks.push(chunk);\n            });\n\n            /*resp.setEncoding('utf8');*/\n\n            resp.on('end', async () => {\n                try {\n                    var rawData = (chunks[0] instanceof Buffer) || (chunks[0] instanceof Uint8Array) ? Buffer.concat(chunks) : chunks.join('');\n                    var data = rawData ? JSON.parse(rawData) : '';\n                    if(resp.statusCode<400) {\n                        resolve({resp, data, req, res, options: _o});\n                    } else {\n                        reject({resp, data, req, res, options: _o});\n                    }\n                } catch (e) {\n                    reject({resp, options: _o, data: {\n                        data: e.message,\n                        status: 500\n                    }, req, res});\n                }\n            });\n        });\n        r.on('error', error => {\n            var message;\n            try {\n                message = JSON.parse(error);\n            } catch (e) {\n                message = error;\n            }\n            reject({resp: r, data: message, options: _o, req, res});\n            // output: {\n            //     data: message,\n            //     status: 500,\n            //     response: r\n            // }\n        });\n\n        r.on('timeout', () => {\n            request.abort();\n            _.partial((_req, _res, o, err, xhr) => _o.catch(err, _req, _res, xhr), req, res, _o)('timeout', r);\n            reject('timeout');\n        });\n\n        if (_o.method !== 'GET' && _o.data) {\n            r.write(_o.data);\n        }\n\n        r.end();\n\n    }, reqOpts)).then(async (o)=>{\n        o.options.then(o.resp, o.data, o.req, o.res, o.options);\n    }).catch(async (o)=>{\n        o.options.catch(o.resp, o.data, o.req, o.res, o.options);\n    });\n\n};\n\nvar defineLib = function (o) {\n    if (o.url) {\n        if (/https/.test(o.url)) {\n            return https;\n        }\n        return http;\n    }\n};\nvar parseBuffer = function (b) {\n    try {\n        return JSON.parse(b);\n    } catch (e) {\n        return b;\n    }\n};\n\nexport default {\n    exec,\n    defineLib,\n    parseBuffer\n};\n","// [backbone-request-99xp](https://github.com/brunnofoggia/backbone-request-99xp) is an integration that makes possible to use\n// [backbone](https://backbonejs.org) with promises in nodejs. That's done by integrating it with [axios](https://github.com/axios/axios).\n\n\n// Examples\n// --------------\n\n// Considere this Model as base for the examples\n//\n//     var Model = bbr.Model.extend({\n//         urlRoot: 'https://tapi.99xp.org/crud/test'\n//     }),\n\n// * getting row \n//   1. with listener\n//\n//          model = new Model({id: 35});\n//          model.once('sync', ()=>{\n//              console.log(model.attributes);\n//          });\n//          model.fetch({headers: {...}});\n//   2. with promise\n//\n//          model = new Model({id: 35});\n//          return model.fetchp((m, o, resolve, reject) => {\n//              console.log(m.attributes);\n//              resolve();\n//          }, {headers: {...}});\n// * inserting row \n//   1. with listener\n//\n//          model = new Model({name: 'new person', age: 10});\n//          model.once('sync', ()=>{\n//              console.log(model.attributes);\n//          });\n//          model.save();\n//   2. with promise\n//\n//          model = new Model({name: 'new person', age: 10});\n//          return model.savep((m, o, resolve, reject) => {\n//              console.log(m.attributes);\n//              resolve();\n//          });\n\n// CODE DOCUMENTED BELOW\n// --------------\n\n// --------------\n\n// Baseline setup\n// --------------\nimport Backbone from 'backbone';\nimport AppException from 'app-exception';\nimport bbx from 'backbone-99xp';\nimport _ from 'underscore-99xp';\nimport http from './http';\n\nvar BackboneRequest = _.extend(_.clone(Backbone), _.clone(http));\n\ndelete BackboneRequest.VERSION;\n\n// Turn on `emulateHTTP` to support legacy HTTP servers. Setting this option\n// will fake `\"PATCH\"`, `\"PUT\"` and `\"DELETE\"` requests via the `_method` parameter and\n// set a `X-Http-Method-Override` header.\nBackboneRequest.emulateHTTP = false;\n\n// Turn on `emulateJSON` to support legacy servers that can't deal with direct\n// `application/json` requests ... this will encode the body as\n// `application/x-www-form-urlencoded` instead and will send the model in a\n// form param named `model`.\nBackboneRequest.emulateJSON = false;\n\n// Sync engine modeled over default backbone.js ajax syncing engine\n// It will make model rest methods to work for both, node and browser\nBackboneRequest.sync = function (method, model, options) {\n    var type = methodMap[method];\n\n    // Default options, unless specified.\n    _.defaults(options || (options = {}), {\n        emulateHTTP: BackboneRequest.emulateHTTP,\n        emulateJSON: BackboneRequest.emulateJSON,\n        headers: {}\n    });\n\n    // Default JSON-request options.\n    var params = _.extend({}, options, {\n        type: type,\n        dataType: 'json'\n    });\n\n    // Ensure that we have a URL.\n    if (!options.url) {\n        params.url = _.result(model, 'url') || BackboneRequest.urlError();\n    }\n\n    // Ensure that we have the appropriate request data.\n    if (model && (method === 'create' || method === 'update' || method === 'patch')) {\n        params.contentType = 'application/json';\n        if (options.data == null) {\n            params.data = (options.attrs || model.toJSON(options));\n        } else {\n            params.data = options.data;\n        }\n    }\n\n    // For older servers, emulate JSON by encoding the request into an HTML-form.\n    if (options.emulateJSON) {\n        params.contentType = 'application/x-www-form-urlencoded';\n        params.data = params.data ? {\n            model: params.data\n        } : {};\n    }\n\n    // For older servers, emulate HTTP by mimicking the HTTP method with `_method`\n    // And an `X-HTTP-Method-Override` header.\n    if (options.emulateHTTP && (type === 'PUT' || type === 'DELETE' || type === 'PATCH')) {\n        params.type = 'POST';\n        if (options.emulateJSON) {\n            params.data._method = type;\n        }\n        params.headers['X-HTTP-Method-Override'] = type;\n    }\n\n    // Don't process data on a non-GET request.\n    if (params.type !== 'GET' && !options.emulateJSON) {\n        params.processData = false;\n    }\n\n    // Request & Parse engine\n    var reqOpts = _.extend({\n        url: params.url,\n        method: params.type,\n        headers: params.headers\n    }, _.omit(options, 'type', 'dataType', 'emulateHTTP', 'emulateJSON'));\n\n    if (params.data) {\n        reqOpts.data = JSON.stringify(params.data);\n    }\n\n    reqOpts.headers['content-type'] = params.contentType || 'application/json';\n\n    // Promise calls\n    reqOpts.then = _.partial((m, o, response, data) => {\n        typeof o.success === 'function' && o.success(data, response);\n    }, this, options);\n    reqOpts.catch = _.bind(_.partial((m, o, response, err) => {\n        this._reqErr = response;\n        typeof o.error === 'function' && o.error({response: response, error: err});\n    }, this, options), this);\n\n\n    return BackboneRequest.exec(reqOpts);\n};\n\n// Map from CRUD to HTTP for our default `Backbone.sync` implementation.\nvar methodMap = {\n    'create': 'POST',\n    'update': 'PUT',\n    'patch': 'PATCH',\n    'delete': 'DELETE',\n    'read': 'GET'\n};\n\n// Throw an error when a URL is needed, and none is supplied.\nBackboneRequest.urlError = function () {\n    throw AppException.internalServerError('A \"url\" property or function must be specified');\n};\n\n\n_.map(['Events'], (x) => BackboneRequest[x] = _.clone(Backbone[x]));\n// Custom behaviors\nvar ext = {\n    'Model': {\n        // constructor\n        initialize(data = {}, options = {}) {\n            this.setRouterParameters(options.req, options.res);\n        },\n        // easier way to have express variables inside the object to use them in callbacks\n        setRouterParameters(req = null, res = null) {\n            this._req = req;\n            this._res = res;\n        },\n        // Replacing prototype of sync to call custom sync method\n        sync() {\n            return BackboneRequest.sync.apply(this, arguments);\n        },\n        // Shortcuts for promise use\n        fetchp(fn, o = {}) {\n            o.success = fn;\n            return this.fetch(o);\n        },\n        savep(fn, o = {}) {\n            o.success = fn;\n            return this.save(null, o);\n        },\n        destroyp(fn, o = {}) {\n            o.success = fn;\n            return this.destroy(o);\n        },\n    },\n    'Collection': {\n        // Replacing prototype of sync to call custom sync method\n        sync() {\n            return BackboneRequest.sync.apply(this, arguments);\n        },\n    }\n};\n_.map(['Model', 'Collection'], (x) => BackboneRequest[x] = bbx[x.toLowerCase()].extend(ext[x]));\n\n\nexport default BackboneRequest;\n"],"names":["exec","options","req","res","url","_","size","pick","defaults","method","rejectUnauthorized","headers","timeout","parseUrl","then","response","data","_req","_res","_headerSent","status","statusCode","send","ExceptionResponse","JSON","stringify","finally","catch","isString","parse","e","message","isObject","reqOpts","defaults2","process","env","NODE_TLS_REJECT_UNAUTHORIZED","isJSON","Buffer","byteLength","Promise","partial","_o","resolve","reject","httprequest","defineLib","r","request","omit","resp","chunks","setEncoding","on","chunk","push","rawData","Uint8Array","concat","join","error","abort","o","err","xhr","write","end","test","https","http","parseBuffer","b","BackboneRequest","extend","clone","Backbone","VERSION","emulateHTTP","emulateJSON","sync","model","type","methodMap","params","dataType","result","urlError","contentType","attrs","toJSON","_method","processData","m","success","bind","_reqErr","AppException","internalServerError","map","x","ext","initialize","setRouterParameters","apply","arguments","fetchp","fn","fetch","savep","save","destroyp","destroy","bbx","toLowerCase"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;IAAA;AAEA;IAKA,IAAIA,IAAI,GAAG,gBAAgBC,OAAhB,EAAyBC,GAAG,GAAG,IAA/B,EAAqCC,GAAG,GAAG,IAA3C,EAAiD;IACxD,MAAI,OAAOF,OAAO,CAACG,GAAf,KAAuB,QAAvB;IAEa,GAACD,GAAD,IAAQE,CAAC,CAACC,IAAF,CAAOD,CAAC,CAACE,IAAF,CAAON,OAAP,EAAgB,MAAhB,EAAwB,OAAxB,CAAP,IAA2C,CAFpE,EAEwE;IACpE,WAAO,KAAP;IACH;;IAED,MAAIO,QAAQ,GAAGH,CAAC,CAACG,QAAF,CAAW;IACtBC,IAAAA,MAAM,EAAE,KADc;IAEtBC,IAAAA,kBAAkB,EAAE,KAFE;IAGtBC,IAAAA,OAAO,EAAE;IACL,sBAAgB;IADX,KAHa;IAMtBC,IAAAA,OAAO,EAAE;IANa,GAAX,EAOZ,CAACX,OAAO,CAACG,GAAT,GAAe,EAAf,GAAoBC,CAAC,CAACQ,QAAF,CAAWZ,OAAO,CAACG,GAAnB,CAPR,CAAf,CAPwD;;;IAiBvD,SAAOH,OAAO,CAACa,IAAf,KAAwB,UAAzB,KAAyCb,OAAO,CAACa,IAAR,GAAe,OAAOC,QAAP,EAAiBC,IAAjB,EAAuBC,IAAvB,EAA6BC,IAA7B,KAAsC;IAC1F,QAAGA,IAAH,EAAS;IACL,aAAO,CAACA,IAAI,CAACC,WAAN,IAAqBD,IAAI,CAACE,MAAL,CAAYL,QAAQ,CAACM,UAAT,IAAuB,GAAnC,EAAwCC,IAAxC,CAA6CN,IAA7C,CAA5B;IACH;;IACD,UAAM,IAAIO,iBAAJ,CAAsBC,IAAI,CAACC,SAAL,CAAeT,IAAf,CAAtB,EAA4C,CAA5C,EAA+CD,QAAQ,CAACM,UAAT,IAAuB,GAAtE,CAAN;IACH,GALD;IAMC,SAAOpB,OAAO,CAACyB,OAAf,KAA2B,UAA5B,KAA4CzB,OAAO,CAACyB,OAAR,GAAkB,YAAY,EAA1E;IAEC,SAAOzB,OAAO,CAAC0B,KAAf,KAAyB,UAA1B,KAA0C1B,OAAO,CAAC0B,KAAR,GAAgB,OAAOZ,QAAP,EAAiBC,IAAjB,EAAuBC,IAAvB,EAA6BC,IAA7B,KAAsC;IAC5F,QAAI;IACA,UAAI,OAAOF,IAAP,KAAgB,QAApB,EAA8B;IAC1B,YAAI;IACAA,UAAAA,IAAI,GAAGX,CAAC,CAACuB,QAAF,CAAWZ,IAAX,IAAmBQ,IAAI,CAACK,KAAL,CAAWb,IAAX,CAAnB,GAAsCA,IAA7C;IACH,SAFD,CAEE,OAAOc,CAAP,EAAU;IACRd,UAAAA,IAAI,GAAG;IACHe,YAAAA,OAAO,EAAEf;IADN,WAAP;IAGH;IACJ;;IAED,UAAII,MAAM,GAAGf,CAAC,CAAC2B,QAAF,CAAWjB,QAAX,IAAuBA,QAAQ,CAACM,UAAT,IAAuB,GAA9C,GAAoD,GAAjE;;IACA,UAAGH,IAAH,EAAS;IACL,eAAO,CAACA,IAAI,CAACC,WAAN,IAAqBD,IAAI,CAACE,MAAL,CAAYA,MAAZ,EAAoBE,IAApB,CAAyBN,IAAzB,CAA5B;IACH;;IACD,YAAM,IAAIO,iBAAJ,CAAsBC,IAAI,CAACC,SAAL,CAAeT,IAAf,CAAtB,EAA4C,CAA5C,EAA+CI,MAA/C,CAAN;IACH,KAhBD,CAgBE,OAAOU,CAAP,EAAU;IACR,UAAGZ,IAAH,EAAS;IACL,eAAO,CAACA,IAAI,CAACC,WAAN,IAAqBD,IAAI,CAACE,MAAL,CAAYf,CAAC,CAAC2B,QAAF,CAAWF,CAAX,IAAgBA,CAAC,CAACT,UAAF,IAAgB,GAAhC,GAAsC,GAAlD,EAAuDC,IAAvD,CAA4DQ,CAA5D,CAA5B;IACH;;IACD,YAAM,IAAIP,iBAAJ,CAAsBO,CAAtB,EAAyB,CAAzB,EAA4BzB,CAAC,CAAC2B,QAAF,CAAWF,CAAX,IAAgBA,CAAC,CAACT,UAAF,IAAgB,GAAhC,GAAsC,GAAlE,CAAN;IACH;IACJ,GAvBD;;IAyBA,MAAIY,OAAO,GAAG5B,CAAC,CAAC6B,SAAF,CAAY7B,CAAC,CAACE,IAAF,CAAON,OAAP,EACtB,KADsB,EACf,QADe,EACL,SADK,EACM,MADN,EACc,SADd,EACyB,gBADzB,EAC2C,YAD3C,EACyD,YADzD,EACuE,MADvE,EAC+E,OAD/E,CAAZ,EAEdO,QAFc,CAAd;;IAIA,MAAI,CAACyB,OAAO,CAACvB,kBAAb,EAAiC;IAC7ByB,IAAAA,OAAO,CAACC,GAAR,CAAYC,4BAAZ,GAA2C,CAA3C;IACH;;IAED,MAAIJ,OAAO,CAACxB,MAAR,KAAmB,KAAnB,IAA4BwB,OAAO,CAACjB,IAAxC,EAA8C;IAC1C,QAAIX,CAAC,CAACiC,MAAF,CAASL,OAAO,CAACjB,IAAjB,CAAJ,EAA4B;IACxBiB,MAAAA,OAAO,CAACjB,IAAR,GAAeQ,IAAI,CAACC,SAAL,CAAeQ,OAAO,CAACjB,IAAvB,CAAf;IACH;;IACDiB,IAAAA,OAAO,CAACtB,OAAR,CAAgB,gBAAhB,IAAoC4B,MAAM,CAACC,UAAP,CAAkBP,OAAO,CAACjB,IAA1B,CAApC;IACH;;IAED,SAAO,IAAIyB,OAAJ,CAAYpC,CAAC,CAACqC,OAAF,CAAU,OAAOC,EAAP,EAAWC,OAAX,EAAoBC,MAApB,KAA+B;IACxD,UAAMC,WAAW,GAAGC,SAAS,CAACJ,EAAD,CAA7B;IAEA,UAAMK,CAAC,GAAGF,WAAW,CAACG,OAAZ,CAAoB5C,CAAC,CAAC6C,IAAF,CAAOP,EAAP,EAAW,MAAX,CAApB,EAAwC,MAAOQ,IAAP,IAAgB;IAC9D,UAAIC,MAAM,GAAG,EAAb;IACAD,MAAAA,IAAI,CAACE,WAAL,CAAiB,MAAjB;IACAF,MAAAA,IAAI,CAACG,EAAL,CAAQ,MAAR,EAAgBC,KAAK,IAAI;IAAEH,QAAAA,MAAM,CAACI,IAAP,CAAYD,KAAZ;IAC1B,OADD;IAGA;;IAEAJ,MAAAA,IAAI,CAACG,EAAL,CAAQ,KAAR,EAAe,YAAY;IACvB,YAAI;IACA,cAAIG,OAAO,GAAIL,MAAM,CAAC,CAAD,CAAN,YAAqBb,MAAtB,IAAkCa,MAAM,CAAC,CAAD,CAAN,YAAqBM,UAAvD,GAAqEnB,MAAM,CAACoB,MAAP,CAAcP,MAAd,CAArE,GAA6FA,MAAM,CAACQ,IAAP,CAAY,EAAZ,CAA3G;IACA,cAAI5C,IAAI,GAAGyC,OAAO,GAAGjC,IAAI,CAACK,KAAL,CAAW4B,OAAX,CAAH,GAAyB,EAA3C;;IACA,cAAGN,IAAI,CAAC9B,UAAL,GAAgB,GAAnB,EAAwB;IACpBuB,YAAAA,OAAO,CAAC;IAACO,cAAAA,IAAD;IAAOnC,cAAAA,IAAP;IAAad,cAAAA,GAAb;IAAkBC,cAAAA,GAAlB;IAAuBF,cAAAA,OAAO,EAAE0C;IAAhC,aAAD,CAAP;IACH,WAFD,MAEO;IACHE,YAAAA,MAAM,CAAC;IAACM,cAAAA,IAAD;IAAOnC,cAAAA,IAAP;IAAad,cAAAA,GAAb;IAAkBC,cAAAA,GAAlB;IAAuBF,cAAAA,OAAO,EAAE0C;IAAhC,aAAD,CAAN;IACH;IACJ,SARD,CAQE,OAAOb,CAAP,EAAU;IACRe,UAAAA,MAAM,CAAC;IAACM,YAAAA,IAAD;IAAOlD,YAAAA,OAAO,EAAE0C,EAAhB;IAAoB3B,YAAAA,IAAI,EAAE;IAC7BA,cAAAA,IAAI,EAAEc,CAAC,CAACC,OADqB;IAE7BX,cAAAA,MAAM,EAAE;IAFqB,aAA1B;IAGJlB,YAAAA,GAHI;IAGCC,YAAAA;IAHD,WAAD,CAAN;IAIH;IACJ,OAfD;IAgBH,KAxBS,CAAV;IAyBA6C,IAAAA,CAAC,CAACM,EAAF,CAAK,OAAL,EAAcO,KAAK,IAAI;IACnB,UAAI9B,OAAJ;;IACA,UAAI;IACAA,QAAAA,OAAO,GAAGP,IAAI,CAACK,KAAL,CAAWgC,KAAX,CAAV;IACH,OAFD,CAEE,OAAO/B,CAAP,EAAU;IACRC,QAAAA,OAAO,GAAG8B,KAAV;IACH;;IACDhB,MAAAA,MAAM,CAAC;IAACM,QAAAA,IAAI,EAAEH,CAAP;IAAUhC,QAAAA,IAAI,EAAEe,OAAhB;IAAyB9B,QAAAA,OAAO,EAAE0C,EAAlC;IAAsCzC,QAAAA,GAAtC;IAA2CC,QAAAA;IAA3C,OAAD,CAAN,CAPmB;IASnB;IACA;IACA;IACA;IACH,KAbD;IAeA6C,IAAAA,CAAC,CAACM,EAAF,CAAK,SAAL,EAAgB,MAAM;IAClBL,MAAAA,OAAO,CAACa,KAAR;;IACAzD,MAAAA,CAAC,CAACqC,OAAF,CAAU,CAACzB,IAAD,EAAOC,IAAP,EAAa6C,CAAb,EAAgBC,GAAhB,EAAqBC,GAArB,KAA6BtB,EAAE,CAAChB,KAAH,CAASqC,GAAT,EAAc/C,IAAd,EAAoBC,IAApB,EAA0B+C,GAA1B,CAAvC,EAAuE/D,GAAvE,EAA4EC,GAA5E,EAAiFwC,EAAjF,EAAqF,SAArF,EAAgGK,CAAhG;;IACAH,MAAAA,MAAM,CAAC,SAAD,CAAN;IACH,KAJD;;IAMA,QAAIF,EAAE,CAAClC,MAAH,KAAc,KAAd,IAAuBkC,EAAE,CAAC3B,IAA9B,EAAoC;IAChCgC,MAAAA,CAAC,CAACkB,KAAF,CAAQvB,EAAE,CAAC3B,IAAX;IACH;;IAEDgC,IAAAA,CAAC,CAACmB,GAAF;IAEH,GAvDkB,EAuDhBlC,OAvDgB,CAAZ,EAuDMnB,IAvDN,CAuDW,MAAOiD,CAAP,IAAW;IACzBA,IAAAA,CAAC,CAAC9D,OAAF,CAAUa,IAAV,CAAeiD,CAAC,CAACZ,IAAjB,EAAuBY,CAAC,CAAC/C,IAAzB,EAA+B+C,CAAC,CAAC7D,GAAjC,EAAsC6D,CAAC,CAAC5D,GAAxC,EAA6C4D,CAAC,CAAC9D,OAA/C;IACH,GAzDM,EAyDJ0B,KAzDI,CAyDE,MAAOoC,CAAP,IAAW;IAChBA,IAAAA,CAAC,CAAC9D,OAAF,CAAU0B,KAAV,CAAgBoC,CAAC,CAACZ,IAAlB,EAAwBY,CAAC,CAAC/C,IAA1B,EAAgC+C,CAAC,CAAC7D,GAAlC,EAAuC6D,CAAC,CAAC5D,GAAzC,EAA8C4D,CAAC,CAAC9D,OAAhD;IACH,GA3DM,CAAP;IA6DH,CA9HD;;IAgIA,IAAI8C,SAAS,GAAG,UAAUgB,CAAV,EAAa;IACzB,MAAIA,CAAC,CAAC3D,GAAN,EAAW;IACP,QAAI,QAAQgE,IAAR,CAAaL,CAAC,CAAC3D,GAAf,CAAJ,EAAyB;IACrB,aAAOiE,KAAP;IACH;;IACD,WAAOC,MAAP;IACH;IACJ,CAPD;;IAQA,IAAIC,WAAW,GAAG,UAAUC,CAAV,EAAa;IAC3B,MAAI;IACA,WAAOhD,IAAI,CAACK,KAAL,CAAW2C,CAAX,CAAP;IACH,GAFD,CAEE,OAAO1C,CAAP,EAAU;IACR,WAAO0C,CAAP;IACH;IACJ,CAND;;AAQA,eAAe;IACXxE,EAAAA,IADW;IAEX+C,EAAAA,SAFW;IAGXwB,EAAAA;IAHW,CAAf;;ICvJA;AACA;IAwDA,IAAIE,eAAe,GAAGpE,CAAC,CAACqE,MAAF,CAASrE,CAAC,CAACsE,KAAF,CAAQC,QAAR,CAAT,EAA4BvE,CAAC,CAACsE,KAAF,CAAQL,IAAR,CAA5B,CAAtB;;IAEA,OAAOG,eAAe,CAACI,OAAvB;IAGA;IACA;;IACAJ,eAAe,CAACK,WAAhB,GAA8B,KAA9B;IAGA;IACA;IACA;;IACAL,eAAe,CAACM,WAAhB,GAA8B,KAA9B;IAGA;;IACAN,eAAe,CAACO,IAAhB,GAAuB,UAAUvE,MAAV,EAAkBwE,KAAlB,EAAyBhF,OAAzB,EAAkC;IACrD,MAAIiF,IAAI,GAAGC,SAAS,CAAC1E,MAAD,CAApB,CADqD;;IAIrDJ,EAAAA,CAAC,CAACG,QAAF,CAAWP,OAAO,KAAKA,OAAO,GAAG,EAAf,CAAlB,EAAsC;IAClC6E,IAAAA,WAAW,EAAEL,eAAe,CAACK,WADK;IAElCC,IAAAA,WAAW,EAAEN,eAAe,CAACM,WAFK;IAGlCpE,IAAAA,OAAO,EAAE;IAHyB,GAAtC,EAJqD;;;IAWrD,MAAIyE,MAAM,GAAG/E,CAAC,CAACqE,MAAF,CAAS,EAAT,EAAazE,OAAb,EAAsB;IAC/BiF,IAAAA,IAAI,EAAEA,IADyB;IAE/BG,IAAAA,QAAQ,EAAE;IAFqB,GAAtB,CAAb,CAXqD;;;IAiBrD,MAAI,CAACpF,OAAO,CAACG,GAAb,EAAkB;IACdgF,IAAAA,MAAM,CAAChF,GAAP,GAAaC,CAAC,CAACiF,MAAF,CAASL,KAAT,EAAgB,KAAhB,KAA0BR,eAAe,CAACc,QAAhB,EAAvC;IACH,GAnBoD;;;IAsBrD,MAAIN,KAAK,KAAKxE,MAAM,KAAK,QAAX,IAAuBA,MAAM,KAAK,QAAlC,IAA8CA,MAAM,KAAK,OAA9D,CAAT,EAAiF;IAC7E2E,IAAAA,MAAM,CAACI,WAAP,GAAqB,kBAArB;;IACA,QAAIvF,OAAO,CAACe,IAAR,IAAgB,IAApB,EAA0B;IACtBoE,MAAAA,MAAM,CAACpE,IAAP,GAAef,OAAO,CAACwF,KAAR,IAAiBR,KAAK,CAACS,MAAN,CAAazF,OAAb,CAAhC;IACH,KAFD,MAEO;IACHmF,MAAAA,MAAM,CAACpE,IAAP,GAAcf,OAAO,CAACe,IAAtB;IACH;IACJ,GA7BoD;;;IAgCrD,MAAIf,OAAO,CAAC8E,WAAZ,EAAyB;IACrBK,IAAAA,MAAM,CAACI,WAAP,GAAqB,mCAArB;IACAJ,IAAAA,MAAM,CAACpE,IAAP,GAAcoE,MAAM,CAACpE,IAAP,GAAc;IACxBiE,MAAAA,KAAK,EAAEG,MAAM,CAACpE;IADU,KAAd,GAEV,EAFJ;IAGH,GArCoD;IAwCrD;;;IACA,MAAIf,OAAO,CAAC6E,WAAR,KAAwBI,IAAI,KAAK,KAAT,IAAkBA,IAAI,KAAK,QAA3B,IAAuCA,IAAI,KAAK,OAAxE,CAAJ,EAAsF;IAClFE,IAAAA,MAAM,CAACF,IAAP,GAAc,MAAd;;IACA,QAAIjF,OAAO,CAAC8E,WAAZ,EAAyB;IACrBK,MAAAA,MAAM,CAACpE,IAAP,CAAY2E,OAAZ,GAAsBT,IAAtB;IACH;;IACDE,IAAAA,MAAM,CAACzE,OAAP,CAAe,wBAAf,IAA2CuE,IAA3C;IACH,GA/CoD;;;IAkDrD,MAAIE,MAAM,CAACF,IAAP,KAAgB,KAAhB,IAAyB,CAACjF,OAAO,CAAC8E,WAAtC,EAAmD;IAC/CK,IAAAA,MAAM,CAACQ,WAAP,GAAqB,KAArB;IACH,GApDoD;;;IAuDrD,MAAI3D,OAAO,GAAG5B,CAAC,CAACqE,MAAF,CAAS;IACnBtE,IAAAA,GAAG,EAAEgF,MAAM,CAAChF,GADO;IAEnBK,IAAAA,MAAM,EAAE2E,MAAM,CAACF,IAFI;IAGnBvE,IAAAA,OAAO,EAAEyE,MAAM,CAACzE;IAHG,GAAT,EAIXN,CAAC,CAAC6C,IAAF,CAAOjD,OAAP,EAAgB,MAAhB,EAAwB,UAAxB,EAAoC,aAApC,EAAmD,aAAnD,CAJW,CAAd;;IAMA,MAAImF,MAAM,CAACpE,IAAX,EAAiB;IACbiB,IAAAA,OAAO,CAACjB,IAAR,GAAeQ,IAAI,CAACC,SAAL,CAAe2D,MAAM,CAACpE,IAAtB,CAAf;IACH;;IAEDiB,EAAAA,OAAO,CAACtB,OAAR,CAAgB,cAAhB,IAAkCyE,MAAM,CAACI,WAAP,IAAsB,kBAAxD,CAjEqD;;IAoErDvD,EAAAA,OAAO,CAACnB,IAAR,GAAeT,CAAC,CAACqC,OAAF,CAAU,CAACmD,CAAD,EAAI9B,CAAJ,EAAOhD,QAAP,EAAiBC,IAAjB,KAA0B;IAC/C,WAAO+C,CAAC,CAAC+B,OAAT,KAAqB,UAArB,IAAmC/B,CAAC,CAAC+B,OAAF,CAAU9E,IAAV,EAAgBD,QAAhB,CAAnC;IACH,GAFc,EAEZ,IAFY,EAENd,OAFM,CAAf;IAGAgC,EAAAA,OAAO,CAACN,KAAR,GAAgBtB,CAAC,CAAC0F,IAAF,CAAO1F,CAAC,CAACqC,OAAF,CAAU,CAACmD,CAAD,EAAI9B,CAAJ,EAAOhD,QAAP,EAAiBiD,GAAjB,KAAyB;IACtD,SAAKgC,OAAL,GAAejF,QAAf;IACA,WAAOgD,CAAC,CAACF,KAAT,KAAmB,UAAnB,IAAiCE,CAAC,CAACF,KAAF,CAAQ;IAAC9C,MAAAA,QAAQ,EAAEA,QAAX;IAAqB8C,MAAAA,KAAK,EAAEG;IAA5B,KAAR,CAAjC;IACH,GAHsB,EAGpB,IAHoB,EAGd/D,OAHc,CAAP,EAGG,IAHH,CAAhB;IAMA,SAAOwE,eAAe,CAACzE,IAAhB,CAAqBiC,OAArB,CAAP;IACH,CA9ED;;;IAiFA,IAAIkD,SAAS,GAAG;IACZ,YAAU,MADE;IAEZ,YAAU,KAFE;IAGZ,WAAS,OAHG;IAIZ,YAAU,QAJE;IAKZ,UAAQ;IALI,CAAhB;;IASAV,eAAe,CAACc,QAAhB,GAA2B,YAAY;IACnC,QAAMU,YAAY,CAACC,mBAAb,CAAiC,gDAAjC,CAAN;IACH,CAFD;;IAKA7F,CAAC,CAAC8F,GAAF,CAAM,CAAC,QAAD,CAAN,EAAmBC,CAAD,IAAO3B,eAAe,CAAC2B,CAAD,CAAf,GAAqB/F,CAAC,CAACsE,KAAF,CAAQC,QAAQ,CAACwB,CAAD,CAAhB,CAA9C;;;IAEA,IAAIC,GAAG,GAAG;IACN,WAAS;IACL;IACAC,IAAAA,UAAU,CAACtF,IAAI,GAAG,EAAR,EAAYf,OAAO,GAAG,EAAtB,EAA0B;IAChC,WAAKsG,mBAAL,CAAyBtG,OAAO,CAACC,GAAjC,EAAsCD,OAAO,CAACE,GAA9C;IACH,KAJI;;IAKL;IACAoG,IAAAA,mBAAmB,CAACrG,GAAG,GAAG,IAAP,EAAaC,GAAG,GAAG,IAAnB,EAAyB;IACxC,WAAKc,IAAL,GAAYf,GAAZ;IACA,WAAKgB,IAAL,GAAYf,GAAZ;IACH,KATI;;IAUL;IACA6E,IAAAA,IAAI,GAAG;IACH,aAAOP,eAAe,CAACO,IAAhB,CAAqBwB,KAArB,CAA2B,IAA3B,EAAiCC,SAAjC,CAAP;IACH,KAbI;;IAcL;IACAC,IAAAA,MAAM,CAACC,EAAD,EAAK5C,CAAC,GAAG,EAAT,EAAa;IACfA,MAAAA,CAAC,CAAC+B,OAAF,GAAYa,EAAZ;IACA,aAAO,KAAKC,KAAL,CAAW7C,CAAX,CAAP;IACH,KAlBI;;IAmBL8C,IAAAA,KAAK,CAACF,EAAD,EAAK5C,CAAC,GAAG,EAAT,EAAa;IACdA,MAAAA,CAAC,CAAC+B,OAAF,GAAYa,EAAZ;IACA,aAAO,KAAKG,IAAL,CAAU,IAAV,EAAgB/C,CAAhB,CAAP;IACH,KAtBI;;IAuBLgD,IAAAA,QAAQ,CAACJ,EAAD,EAAK5C,CAAC,GAAG,EAAT,EAAa;IACjBA,MAAAA,CAAC,CAAC+B,OAAF,GAAYa,EAAZ;IACA,aAAO,KAAKK,OAAL,CAAajD,CAAb,CAAP;IACH;;IA1BI,GADH;IA6BN,gBAAc;IACV;IACAiB,IAAAA,IAAI,GAAG;IACH,aAAOP,eAAe,CAACO,IAAhB,CAAqBwB,KAArB,CAA2B,IAA3B,EAAiCC,SAAjC,CAAP;IACH;;IAJS;IA7BR,CAAV;;IAoCApG,CAAC,CAAC8F,GAAF,CAAM,CAAC,OAAD,EAAU,YAAV,CAAN,EAAgCC,CAAD,IAAO3B,eAAe,CAAC2B,CAAD,CAAf,GAAqBa,GAAG,CAACb,CAAC,CAACc,WAAF,EAAD,CAAH,CAAqBxC,MAArB,CAA4B2B,GAAG,CAACD,CAAD,CAA/B,CAA3D;;;;;;;;;;;;"}