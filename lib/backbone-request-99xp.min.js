/**
* @license
* backbone-request 99xp
* ----------------------------------
* v1.5.0-beta
*
* Copyright (c)2020 Bruno Foggia, 99xp.
* Distributed under MIT license
*
* https://backbone-request.99xp.org
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("backbone"),require("app-exception"),require("backbone-99xp"),require("underscore-99xp"),require("https"),require("http"),require("app-exception/src/Response")):"function"==typeof define&&define.amd?define(["exports","backbone","app-exception","backbone-99xp","underscore-99xp","https","http","app-exception/src/Response"],t):t((e=e||self).BackboneRequest={},e.Backbone,e.AppException,e.bbx,e._,e.https,e.http,e.ExceptionResponse)}(this,function(e,t,r,a,n,s,o,u){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t,r=r&&r.hasOwnProperty("default")?r.default:r,a=a&&a.hasOwnProperty("default")?a.default:a,n=n&&n.hasOwnProperty("default")?n.default:n,s=s&&s.hasOwnProperty("default")?s.default:s,o=o&&o.hasOwnProperty("default")?o.default:o,u=u&&u.hasOwnProperty("default")?u.default:u;var c=function(e){if(e.url)return/https/.test(e.url)?s:o},i={exec:async function(e,t=null,r=null){if("string"!=typeof e.url||!r&&n.size(n.pick(e,"then","catch"))<2)return!1;var a=n.defaults({method:"GET",rejectUnauthorized:!1,headers:{"content-type":"application/json"},timeout:18e6},e.url?n.parseUrl(e.url):{});"function"!=typeof e.then&&(e.then=(async(e,t,r,a)=>{if(a)return!a._headerSent&&a.status(e.statusCode||200).send(t);throw new u(JSON.stringify(t),0,e.statusCode||200)})),"function"!=typeof e.finally&&(e.finally=(async()=>{})),"function"!=typeof e.catch&&(e.catch=(async(e,t,r,a)=>{try{if("object"!=typeof t)try{t=n.isString(t)?JSON.parse(t):t}catch(e){t={message:t}}var s=n.isObject(e)&&e.statusCode||500;if(a)return!a._headerSent&&a.status(s).send(t);throw new u(JSON.stringify(t),0,s)}catch(e){if(a)return!a._headerSent&&a.status(n.isObject(e)&&e.statusCode||500).send(e);throw new u(e,0,n.isObject(e)&&e.statusCode||500)}}));var s=n.defaults2(n.pick(e,"url","method","headers","data","timeout","secureProtocol","minVersion","maxVersion","then","catch"),a);return s.rejectUnauthorized||(process.env.NODE_TLS_REJECT_UNAUTHORIZED=0),"GET"!==s.method&&s.data&&(n.isJSON(s.data)&&(s.data=JSON.stringify(s.data)),s.headers["Content-Length"]=Buffer.byteLength(s.data)),new Promise(n.partial(async(e,a,s)=>{const o=c(e).request(n.omit(e,"data"),async n=>{let o=[];n.setEncoding("utf8"),n.on("data",e=>{o.push(e)}),n.on("end",async()=>{try{var u=o[0]instanceof Buffer||o[0]instanceof Uint8Array?Buffer.concat(o):o.join(""),c=u?JSON.parse(u):"";n.statusCode<400?a({resp:n,data:c,req:t,res:r,options:e}):s({resp:n,data:c,req:t,res:r,options:e})}catch(a){s({resp:n,options:e,data:{data:a.message,status:500},req:t,res:r})}})});o.on("error",a=>{var n;try{n=JSON.parse(a)}catch(e){n=a}s({resp:o,data:n,options:e,req:t,res:r})}),o.on("timeout",()=>{request.abort(),n.partial((t,r,a,n,s)=>e.catch(n,t,r,s),t,r,e)("timeout",o),s("timeout")}),"GET"!==e.method&&e.data&&o.write(e.data),o.end()},s)).then(async e=>{e.options.then(e.resp,e.data,e.req,e.res,e.options)}).catch(async e=>{e.options.catch(e.resp,e.data,e.req,e.res,e.options)})},defineLib:c,parseBuffer:function(e){try{return JSON.parse(e)}catch(t){return e}}},p=n.extend(n.clone(t),n.clone(i));delete p.VERSION,p.emulateHTTP=!1,p.emulateJSON=!1,p.sync=function(e,t,r){var a=d[e];n.defaults(r||(r={}),{emulateHTTP:p.emulateHTTP,emulateJSON:p.emulateJSON,headers:{}});var s=n.extend({},r,{type:a,dataType:"json"});r.url||(s.url=n.result(t,"url")||p.urlError()),!t||"create"!==e&&"update"!==e&&"patch"!==e||(s.contentType="application/json",null==r.data?s.data=r.attrs||t.toJSON(r):s.data=r.data),r.emulateJSON&&(s.contentType="application/x-www-form-urlencoded",s.data=s.data?{model:s.data}:{}),!r.emulateHTTP||"PUT"!==a&&"DELETE"!==a&&"PATCH"!==a||(s.type="POST",r.emulateJSON&&(s.data._method=a),s.headers["X-HTTP-Method-Override"]=a),"GET"===s.type||r.emulateJSON||(s.processData=!1);var o=n.extend({url:s.url,method:s.type,headers:s.headers},n.omit(r,"type","dataType","emulateHTTP","emulateJSON"));return s.data&&(o.data=JSON.stringify(s.data)),o.headers["content-type"]=s.contentType||"application/json",o.then=n.partial((e,t,r,a)=>{"function"==typeof t.success&&t.success(a,r)},this,r),o.catch=n.bind(n.partial((e,t,r,a)=>{this._reqErr=r,"function"==typeof t.error&&t.error({response:r,error:a})},this,r),this),p.exec(o)};var d={create:"POST",update:"PUT",patch:"PATCH",delete:"DELETE",read:"GET"};p.urlError=function(){throw r.internalServerError('A "url" property or function must be specified')},n.map(["Events"],e=>p[e]=n.clone(t[e]));var l={Model:{initialize(e={},t={}){this.setRouterParameters(t.req,t.res)},setRouterParameters(e=null,t=null){this._req=e,this._res=t},sync(){return p.sync.apply(this,arguments)},fetchp(e,t={}){return t.success=e,this.fetch(t)},savep(e,t={}){return t.success=e,this.save(null,t)},destroyp(e,t={}){return t.success=e,this.destroy(t)}},Collection:{sync(){return p.sync.apply(this,arguments)}}};n.map(["Model","Collection"],e=>p[e]=a[e.toLowerCase()].extend(l[e])),e.default=p,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=backbone-request-99xp.min.js.map
